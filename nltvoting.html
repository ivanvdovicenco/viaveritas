<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cru Agenda</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* CRU BRAND PALETTE */
            --cru-gold: #f9b625;
            --cru-gold-hover: #dca01e;
            --cru-charcoal: #212121;
            --cru-gray-bg: #f7f7f7;
            --text-main: #333333;
            --text-light: #777777;
            --white: #ffffff;
            
            --card-shadow: 0 10px 30px rgba(0,0,0,0.06);
            --radius: 8px;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background-color: var(--cru-gray-bg);
            margin: 0;
            padding: 20px;
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        h1, h2, h3, button, input, label, .card-title {
            font-family: 'Montserrat', sans-serif;
        }

        .container { max-width: 1150px; margin: 0 auto; }
        .hidden { display: none !important; }

        /* --- UI COMPONENTS --- */
        
        /* 1. HEADER */
        .app-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 0; margin-bottom: 40px; flex-wrap: wrap; gap: 20px;
        }
        
        .logo {
            font-weight: 800; font-size: 24px; color: var(--cru-charcoal);
            text-transform: uppercase; letter-spacing: 1px; border-bottom: 3px solid var(--cru-gold);
            padding-bottom: 5px;
        }

        .controls { display: flex; gap: 12px; }

        .btn {
            border: none; padding: 10px 20px; border-radius: 4px; 
            font-weight: 700; font-size: 13px; cursor: pointer; 
            text-transform: uppercase; letter-spacing: 0.5px; transition: 0.3s;
            display: flex; align-items: center; gap: 8px;
        }
        
        .btn-gold { background: var(--cru-gold); color: var(--cru-charcoal); }
        .btn-gold:hover { background: var(--cru-gold-hover); transform: translateY(-1px); }
        
        .btn-outline { background: transparent; border: 2px solid #ddd; color: var(--text-light); }
        .btn-outline:hover { border-color: var(--cru-charcoal); color: var(--cru-charcoal); background: white;}

        .btn-danger-ghost { background: #fff0f0; color: #d32f2f; }
        .btn-danger-ghost:hover { background: #ffebee; }

        /* 2. CREATOR DASHBOARD */
        .dashboard-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        @media(max-width: 800px) { .dashboard-layout { grid-template-columns: 1fr; } }

        .panel {
            background: var(--white); padding: 35px; border-radius: var(--radius);
            box-shadow: var(--card-shadow); border-top: 4px solid var(--cru-gold);
        }

        .panel h2 { margin-top: 0; font-size: 18px; color: var(--cru-charcoal); margin-bottom: 25px; }

        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 11px; font-weight: 700; color: #999; margin-bottom: 8px; text-transform: uppercase; }
        
        input, textarea {
            width: 100%; padding: 12px; border: 1px solid #e0e0e0; background: #fafafa;
            border-radius: 4px; font-size: 14px; color: var(--text-main);
            transition: 0.3s; box-sizing: border-box; font-family: 'Open Sans', sans-serif;
        }
        input:focus, textarea:focus { border-color: var(--cru-gold); background: #fff; outline: none; }
        textarea { min-height: 80px; resize: vertical; }

        .preview-list { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .preview-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 15px; background: #fafafa; border-radius: 4px; border-left: 3px solid var(--cru-charcoal);
        }
        .preview-title { font-weight: 700; font-size: 14px; }
        .preview-time { font-size: 12px; color: #888; margin-left: 10px; }
        .del-icon { cursor: pointer; color: #ccc; transition: 0.2s; }
        .del-icon:hover { color: #d32f2f; }

        /* 3. CARDS (VOTING) */
        .cards-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; }
        
        .card-wrapper {
            flex: 1 1 300px; max-width: 350px; min-width: 280px; height: 480px;
            perspective: 1000px; cursor: pointer;
            transition: all 0.5s ease;
        }
        /* Анимация скрытия */
        .card-wrapper.hidden-card { 
            transform: scale(0.9); opacity: 0; pointer-events: none; height: 0; margin: 0; overflow: hidden; 
        }

        .card-flipper {
            position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
            transform-style: preserve-3d; border-radius: var(--radius);
            box-shadow: var(--card-shadow);
        }
        .card-wrapper.flipped .card-flipper { transform: rotateY(180deg); }

        .card-front, .card-back {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: var(--radius); background: white; display: flex; flex-direction: column; overflow: hidden;
        }
        .card-back { transform: rotateY(180deg); background: #fff; border: 1px solid #eee; }

        /* HEADER CARD STYLE (Dark Charcoal + Gold) */
        .card-header-visual {
            background-color: var(--cru-charcoal);
            padding: 30px 20px; text-align: center; color: white;
            position: relative; flex-shrink: 0;
        }
        .card-header-visual::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: var(--cru-gold);
        }

        .topic-icon { font-size: 48px; margin-bottom: 15px; color: var(--cru-gold); }
        .custom-img { height: 50px; object-fit: contain; margin-bottom: 15px; filter: brightness(0) invert(1); } /* Make white */
        
        .card-title { font-size: 20px; font-weight: 700; margin: 0; line-height: 1.3; text-transform: uppercase; }
        .card-time { 
            display: inline-block; margin-top: 10px; font-size: 11px; font-weight: 700; 
            letter-spacing: 1px; color: #999; border: 1px solid #555; padding: 4px 10px; border-radius: 20px;
        }

        .card-body { flex-grow: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .hint-text { font-size: 11px; color: #aaa; text-transform: uppercase; letter-spacing: 1px; margin-top: auto; padding-top: 10px;}

        .card-footer { padding: 25px; display: flex; justify-content: center; border-top: 1px solid #f5f5f5; }

        /* VOTE BUTTON STYLE */
        .vote-btn {
            background: white; border: 2px solid #eee; color: #999;
            padding: 12px 30px; border-radius: 50px; font-weight: 700; font-size: 14px;
            cursor: pointer; display: flex; gap: 10px; align-items: center; transition: 0.3s;
            font-family: 'Montserrat', sans-serif;
        }
        .vote-btn:hover { border-color: var(--cru-charcoal); color: var(--cru-charcoal); }
        
        .vote-btn.voted {
            background: var(--cru-gold); border-color: var(--cru-gold); color: var(--cru-charcoal);
            box-shadow: 0 4px 15px rgba(249, 182, 37, 0.3);
        }
        .vote-count { background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; font-size: 12px; }

        /* COMPLETE CHECKMARK (The requested feature) */
        .leader-badge {
            position: absolute; top: 15px; right: 15px;
            width: 36px; height: 36px; background: var(--cru-gold); color: var(--cru-charcoal);
            border-radius: 50%; display: none; /* Hidden by default */
            align-items: center; justify-content: center; font-size: 18px;
            cursor: pointer; z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .leader-badge:hover { transform: scale(1.15); background: white; }

        /* BACK SIDE */
        .card-back-content { padding: 30px; text-align: left; }
        .section-label { 
            color: var(--cru-gold); font-size: 11px; font-weight: 800; letter-spacing: 1px; 
            text-transform: uppercase; margin-bottom: 8px; display: block; 
        }
        .text-block { font-size: 14px; line-height: 1.6; margin-bottom: 25px; color: #444; }

        /* --- MODAL (Beautiful Overlay) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(33, 33, 33, 0.6); backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: 0.3s; z-index: 1000;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal-box {
            background: white; width: 90%; max-width: 400px; padding: 40px;
            border-radius: 8px; text-align: center; transform: translateY(20px);
            transition: 0.3s; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            border-top: 5px solid var(--cru-gold);
        }
        .modal-overlay.active .modal-box { transform: translateY(0); }

        .modal-icon-lg { font-size: 50px; color: var(--cru-gold); margin-bottom: 20px; }
        .modal-title { font-size: 22px; font-weight: 700; margin-bottom: 10px; color: var(--cru-charcoal); }
        .modal-desc { font-size: 15px; color: #666; margin-bottom: 30px; }
        
        .modal-actions { display: flex; gap: 15px; }
        .btn-modal-cancel { flex: 1; background: #f0f0f0; color: #333; }
        .btn-modal-confirm { flex: 1; background: var(--cru-charcoal); color: white; }
        .btn-modal-confirm:hover { background: #000; }

        /* Icons Select Grid */
        .icon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; }
        .icon-opt { 
            height: 40px; display: flex; align-items: center; justify-content: center; 
            border: 1px solid #eee; cursor: pointer; color: #999; border-radius: 4px;
        }
        .icon-opt:hover, .icon-opt.selected { background: var(--cru-charcoal); color: var(--cru-gold); border-color: var(--cru-charcoal); }

    </style>
</head>
<body>

<div class="container app-header">
    <div class="logo">Cru Agenda</div>
    <div id="creatorControls" class="controls">
        </div>
    <div id="votingControls" class="controls hidden">
        <button class="btn btn-gold" onclick="shareLink()"><i class="fa-solid fa-link"></i> Ссылка</button>
        <button class="btn btn-outline" id="showAllBtn"><i class="fa-solid fa-box-archive"></i> Архив вопросов</button>
        <button class="btn btn-danger-ghost" id="resetBtn"><i class="fa-solid fa-rotate-right"></i> Сброс</button>
    </div>
</div>

<div id="creatorView" class="container">
    <div class="dashboard-layout">
        <div class="panel">
            <h2><i class="fa-solid fa-pen"></i> Создание вопроса</h2>
            <div class="form-group">
                <label>Заголовок</label>
                <input type="text" id="inpTitle" placeholder="Название темы...">
            </div>
            <div class="form-group">
                <label>Время</label>
                <input type="text" id="inpTime" placeholder="30 мин">
            </div>
            <div class="form-group">
                <label>Иконка</label>
                <input type="text" id="inpImg" placeholder="Ссылка на картинку (URL) - опционально" style="margin-bottom:10px; font-size:12px;">
                <div class="icon-grid" id="iconGrid"></div>
            </div>
            <div class="form-group">
                <label>Описание (Лицевая сторона)</label>
                <textarea id="inpDesc" placeholder="Краткая суть..."></textarea>
            </div>
            <div class="form-group">
                <label>Ожидания (Оборотная сторона)</label>
                <textarea id="inpExpect" placeholder="Результат обсуждения..."></textarea>
            </div>
            <button class="btn btn-gold" style="width:100%; justify-content:center;" onclick="addCard()">
                <i class="fa-solid fa-plus"></i> Добавить
            </button>
        </div>

        <div class="panel">
            <h2>Список (<span id="countDisplay">0</span>)</h2>
            <div id="previewList" class="preview-list"></div>
            
            <div style="margin-top: 40px; text-align: center; border-top: 1px solid #eee; padding-top: 30px;">
                <label>ID Встречи (для ссылки)</label>
                <input type="text" id="slugInput" style="text-align:center; font-weight:bold; letter-spacing:1px; margin-bottom:15px;" placeholder="team-meeting">
                <button class="btn btn-secondary" style="width:100%; justify-content:center;" onclick="publish()">
                    Создать встречу
                </button>
            </div>
        </div>
    </div>
</div>

<div id="votingView" class="container hidden">
    <h2 style="text-align:center; margin-bottom:30px; color:#999; text-transform:uppercase; letter-spacing:2px; font-size:14px;">
        <span id="viewTitle">ID</span>
    </h2>
    <div class="cards-grid" id="cardsGrid">
        </div>
</div>

<div class="modal-overlay" id="finishModal">
    <div class="modal-box">
        <i class="fa-solid fa-circle-check modal-icon-lg"></i>
        <div class="modal-title">Завершить обсуждение?</div>
        <div class="modal-desc">Вопрос "<span id="modalTopicName" style="font-weight:bold"></span>" будет скрыт из общего списка.</div>
        <div class="modal-actions">
            <button class="btn btn-modal-cancel" onclick="closeModal()">Отмена</button>
            <button class="btn btn-modal-confirm" onclick="confirmFinish()">Завершить</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction, set, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyBZuH0pKTmfLbyz9lg1g0cC5S4MM16XpMk",
      authDomain: "cru-moldova-ivan.firebaseapp.com",
      databaseURL: "https://cru-moldova-ivan-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cru-moldova-ivan",
      storageBucket: "cru-moldova-ivan.appspot.com",
      messagingSenderId: "913901012780",
      appId: "1:913901012780:web:aefc6983075e50e4000e89",
      measurementId: "G-2JYYSMTDER"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // State
    let localAgenda = [];
    let selectedIcon = "fa-comments";
    const iconList = ["fa-comments", "fa-bullhorn", "fa-users", "fa-chart-pie", "fa-rocket", "fa-lightbulb", "fa-handshake", "fa-calendar-days", "fa-earth-americas"];
    
    // Routing
    const params = new URLSearchParams(window.location.search);
    const mId = params.get('id');

    if (mId) {
        document.getElementById('creatorView').classList.add('hidden');
        document.getElementById('votingView').classList.remove('hidden');
        document.getElementById('votingControls').classList.remove('hidden');
        document.getElementById('viewTitle').innerText = mId;
        initVoting(mId);
    } else {
        initCreator();
    }

    // --- CREATOR LOGIC ---
    function initCreator() {
        const grid = document.getElementById('iconGrid');
        iconList.forEach(icon => {
            const el = document.createElement('div');
            el.className = `icon-opt ${icon === selectedIcon ? 'selected' : ''}`;
            el.innerHTML = `<i class="fa-solid ${icon}"></i>`;
            el.onclick = () => {
                document.querySelectorAll('.icon-opt').forEach(i => i.classList.remove('selected'));
                el.classList.add('selected');
                selectedIcon = icon;
            };
            grid.appendChild(el);
        });
    }

    window.addCard = () => {
        const title = document.getElementById('inpTitle').value;
        if (!title) return alert("Введите название!");
        
        localAgenda.push({
            id: Date.now(),
            title,
            time: document.getElementById('inpTime').value || "15 мин",
            desc: document.getElementById('inpDesc').value,
            expect: document.getElementById('inpExpect').value,
            icon: selectedIcon,
            img: document.getElementById('inpImg').value
        });
        
        // Clear
        document.getElementById('inpTitle').value = "";
        document.getElementById('inpDesc').value = "";
        document.getElementById('inpExpect').value = "";
        renderPreview();
    };

    function renderPreview() {
        const list = document.getElementById('previewList');
        document.getElementById('countDisplay').innerText = localAgenda.length;
        list.innerHTML = '';
        localAgenda.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.innerHTML = `
                <div><span class="preview-title">${item.title}</span> <span class="preview-time">${item.time}</span></div>
                <i class="fa-solid fa-trash del-icon" onclick="removeCard(${idx})"></i>
            `;
            list.appendChild(div);
        });
    }

    window.removeCard = (idx) => { localAgenda.splice(idx, 1); renderPreview(); };

    window.publish = async () => {
        const slug = document.getElementById('slugInput').value.trim() || 'meeting-' + Math.floor(Math.random()*1000);
        if (localAgenda.length === 0) return alert("Список пуст");
        
        // Add index ID
        const finalData = localAgenda.map((item, i) => ({...item, id: i+1}));
        await set(ref(db, `meetings/${slug}/agenda`), finalData);
        window.location.href = `?id=${slug}`;
    };

    // --- VOTING LOGIC ---
    let myVotes = {};
    let activeModalId = null;

    async function initVoting(id) {
        const snap = await get(ref(db, `meetings/${id}/agenda`));
        if (!snap.exists()) return document.getElementById('cardsGrid').innerHTML = "Встреча не найдена";
        
        const data = snap.val();
        myVotes = JSON.parse(localStorage.getItem(`votes_${id}`)) || {};
        const container = document.getElementById('cardsGrid');

        data.forEach(item => {
            // Check icon type (FontAwesome or Image)
            let iconHtml = `<i class="topic-icon fa-solid ${item.icon}"></i>`;
            if (item.img) iconHtml = `<img src="${item.img}" class="custom-img">`;

            const btnClass = myVotes[item.id] ? 'vote-btn voted' : 'vote-btn';
            const btnIcon = myVotes[item.id] ? 'fa-solid fa-check' : 'fa-regular fa-thumbs-up';
            const btnText = myVotes[item.id] ? 'ГОЛОС ОТДАН' : 'ГОЛОСОВАТЬ';

            const card = document.createElement('div');
            card.className = 'card-wrapper';
            card.id = `card-${item.id}`;
            card.innerHTML = `
                <div class="card-flipper">
                    <div class="card-front">
                        <div class="card-header-visual">
                            <div class="leader-badge" id="leader-${item.id}" title="Завершить обсуждение">
                                <i class="fa-solid fa-check"></i>
                            </div>
                            
                            ${iconHtml}
                            <h3 class="card-title">${item.title}</h3>
                            <span class="card-time">${item.time}</span>
                        </div>
                        <div class="card-body">
                             <div class="click-hint"><i class="fa-solid fa-rotate"></i> Нажми для деталей</div>
                        </div>
                        <div class="card-footer">
                            <button class="${btnClass}" id="btn-${item.id}">
                                <i class="${btnIcon}" id="icon-${item.id}"></i>
                                <span id="txt-${item.id}">${btnText}</span>
                                <span class="vote-count" id="count-${item.id}">0</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-back">
                        <div class="card-back-content">
                            <span class="section-label">Контекст</span>
                            <div class="text-block">${(item.desc || '').replace(/\n/g, '<br>')}</div>
                            
                            <span class="section-label">Ожидания</span>
                            <div class="text-block">${(item.expect || '').replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Flip logic
            card.onclick = (e) => {
                // Don't flip if clicking buttons
                if (e.target.closest('button') || e.target.closest('.leader-badge')) return;
                card.classList.toggle('flipped');
            };

            container.appendChild(card);

            // Bind Events
            document.getElementById(`btn-${item.id}`).onclick = () => toggleVote(item.id, id);
            
            // Bind Modal Trigger
            document.getElementById(`leader-${item.id}`).onclick = (e) => {
                e.stopPropagation();
                openModal(item.id, item.title);
            };
        });

        // Listen for Realtime Updates
        onValue(ref(db, `meetings/${id}`), (snapshot) => {
            const val = snapshot.val() || {};
            const votes = val.votes || {};
            const hidden = val.hidden || {};
            let maxVotes = 0;

            // 1. Calculate Max Votes among VISIBLE cards
            data.forEach(item => {
                if (!hidden[item.id]) {
                    const c = votes[item.id] || 0;
                    if (c > maxVotes) maxVotes = c;
                }
            });

            // 2. Update UI
            data.forEach(item => {
                const cardEl = document.getElementById(`card-${item.id}`);
                const countEl = document.getElementById(`count-${item.id}`);
                const badgeEl = document.getElementById(`leader-${item.id}`);
                const voteCount = votes[item.id] || 0;

                // Hide/Show
                if (hidden[item.id]) {
                    cardEl.classList.add('hidden-card');
                } else {
                    cardEl.classList.remove('hidden-card');
                }

                // Update Count
                countEl.innerText = voteCount;

                // Show Badge only if Leader AND has votes
                if (maxVotes > 0 && voteCount === maxVotes && !hidden[item.id]) {
                    badgeEl.style.display = 'flex';
                } else {
                    badgeEl.style.display = 'none';
                }
            });
        });

        // Controls
        document.getElementById('resetBtn').onclick = () => {
            if(confirm("Сбросить голоса?")) {
                set(ref(db, `meetings/${id}/votes`), {});
                localStorage.removeItem(`votes_${id}`);
                location.reload();
            }
        };

        document.getElementById('showAllBtn').onclick = () => {
             if(confirm("Вернуть скрытые карточки?")) {
                 set(ref(db, `meetings/${id}/hidden`), null);
             }
        };

        window.shareLink = () => { navigator.clipboard.writeText(window.location.href); alert("Ссылка скопирована!"); };
    }

    // --- VOTING ACTION ---
    function toggleVote(itemId, meetingId) {
        const itemRef = ref(db, `meetings/${meetingId}/votes/${itemId}`);
        const btn = document.getElementById(`btn-${itemId}`);
        const icon = document.getElementById(`icon-${itemId}`);
        const txt = document.getElementById(`txt-${itemId}`);

        if (myVotes[itemId]) {
            // Remove
            runTransaction(itemRef, (c) => (c || 0) > 0 ? c - 1 : 0);
            delete myVotes[itemId];
            btn.classList.remove('voted');
            icon.className = 'fa-regular fa-thumbs-up';
            txt.innerText = 'ГОЛОСОВАТЬ';
        } else {
            // Add
            runTransaction(itemRef, (c) => (c || 0) + 1);
            myVotes[itemId] = true;
            btn.classList.add('voted');
            icon.className = 'fa-solid fa-check';
            txt.innerText = 'ГОЛОС ОТДАН';
        }
        localStorage.setItem(`votes_${meetingId}`, JSON.stringify(myVotes));
    }

    // --- MODAL LOGIC ---
    window.openModal = (id, title) => {
        activeModalId = id;
        document.getElementById('modalTopicName').innerText = title;
        document.getElementById('finishModal').classList.add('active');
    };

    window.closeModal = () => {
        document.getElementById('finishModal').classList.remove('active');
        activeModalId = null;
    };

    window.confirmFinish = () => {
        if (activeModalId && mId) {
            set(ref(db, `meetings/${mId}/hidden/${activeModalId}`), true);
            closeModal();
        }
    };

</script>
</body>
</html>

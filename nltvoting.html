<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cru Agenda Builder</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* CRU COLOR PALETTE */
            --cru-gold: #f9b625;
            --cru-gold-hover: #e5a00d;
            --cru-dark: #212121; /* Almost black */
            --cru-gray: #f4f4f4; /* Background */
            --cru-blue: #007398;
            --text-main: #3b3b3b;
            --text-light: #6e6e6e;
            --white: #ffffff;
            --border-radius: 8px; /* Cru uses slightly squarer corners usually */
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background-color: var(--cru-gray);
            margin: 0;
            padding: 20px;
            color: var(--text-main);
            line-height: 1.6;
        }

        h1, h2, h3, .card-title, .preview-title, label {
            font-family: 'Montserrat', sans-serif;
        }

        .container { max-width: 1100px; margin: 0 auto; }
        .hidden { display: none !important; }

        /* --- DASHBOARD STYLES (Modern & Clean) --- */
        .header-logo {
            text-align: center; margin-bottom: 40px;
        }
        .header-logo h1 {
            font-weight: 800; font-size: 28px; color: var(--cru-dark); text-transform: uppercase; letter-spacing: 1px;
            display: inline-block; border-bottom: 4px solid var(--cru-gold); padding-bottom: 5px;
        }

        .dashboard-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 40px; }
        @media(max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }
        
        .panel {
            background: var(--white); border-radius: var(--border-radius); 
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); padding: 35px;
            border: 1px solid #eee;
        }

        h2 { 
            font-size: 20px; color: var(--cru-dark); margin-top: 0; margin-bottom: 25px; 
            font-weight: 700; display: flex; align-items: center; gap: 10px;
        }

        /* FORM STYLES */
        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 12px; font-weight: 700; color: var(--text-light); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input, textarea {
            width: 100%; padding: 12px 15px; 
            border: 1px solid #ddd; background: #fafafa;
            border-radius: 4px; font-family: inherit; font-size: 15px; 
            transition: 0.3s; box-sizing: border-box; color: var(--cru-dark);
        }
        input:focus, textarea:focus { 
            border-color: var(--cru-gold); background: #fff; outline: none; 
            box-shadow: 0 0 0 3px rgba(249, 182, 37, 0.2);
        }
        textarea { resize: vertical; min-height: 100px; }

        /* ICON GRID */
        .icon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 8px; margin-top: 10px; }
        .icon-option {
            height: 45px; display: flex; align-items: center; justify-content: center;
            border: 1px solid #eee; border-radius: 4px; cursor: pointer;
            font-size: 18px; color: var(--text-light); transition: 0.2s;
        }
        .icon-option:hover { background: #fff8e1; border-color: var(--cru-gold); color: var(--cru-dark); }
        .icon-option.selected { background: var(--cru-gold); color: var(--cru-dark); border-color: var(--cru-gold); font-weight: bold; }

        .url-input-toggle { font-size: 12px; color: var(--cru-blue); cursor: pointer; margin-top: 8px; font-weight: 600; }
        .url-input-toggle:hover { text-decoration: underline; }

        /* BUTTONS (Cru Style) */
        .btn-primary {
            width: 100%; background: var(--cru-gold); color: var(--cru-dark); border: none;
            padding: 16px; border-radius: 4px; font-weight: 700; font-size: 16px; letter-spacing: 0.5px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.2s; text-transform: uppercase; font-family: 'Montserrat', sans-serif;
        }
        .btn-primary:hover { background: var(--cru-gold-hover); transform: translateY(-1px); }

        .btn-secondary {
            width: 100%; background: var(--cru-dark); color: white; border: none;
            padding: 16px; border-radius: 4px; font-weight: 700; font-size: 16px; letter-spacing: 0.5px;
            cursor: pointer; transition: 0.2s; text-transform: uppercase; font-family: 'Montserrat', sans-serif;
        }
        .btn-secondary:hover { background: #333; }

        /* LIST PREVIEW */
        .preview-list { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .preview-item {
            display: flex; align-items: center; gap: 15px; padding: 12px 15px;
            background: #fff; border-left: 4px solid var(--cru-gold); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-radius: 0 4px 4px 0;
        }
        .preview-title { font-weight: 700; color: var(--cru-dark); font-size: 14px; }
        .preview-time { font-size: 11px; color: #888; text-transform: uppercase; margin-top: 2px;}
        .btn-delete { color: #ccc; background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px; margin-left: auto; transition: 0.2s;}
        .btn-delete:hover { color: #d32f2f; }

        .create-section { margin-top: 30px; text-align: center; border-top: 1px solid #eee; padding-top: 30px;}
        .slug-input { 
            font-size: 18px; font-weight: bold; text-align: center; max-width: 100%; margin-bottom: 20px; 
            border: 2px solid var(--cru-gold); background: #fffcf5;
        }

        /* --- VOTING VIEW --- */
        .voting-header {
            background: var(--white); padding: 15px 30px; border-radius: var(--border-radius); 
            margin-bottom: 40px; display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-top: 4px solid var(--cru-gold);
        }
        .meeting-title { font-weight: 800; font-size: 20px; color: var(--cru-dark); text-transform: uppercase; }
        
        .header-btn { 
            border: 1px solid #ddd; background: white; color: var(--text-main);
            padding: 8px 18px; border-radius: 4px; font-weight: 600; cursor: pointer; 
            margin-left: 10px; transition: 0.2s; font-size: 13px;
        }
        .header-btn:hover { background: #f4f4f4; border-color: #ccc; }
        .header-btn.danger { color: #d32f2f; border-color: #ffcdd2; background: #fffaf0; }
        .header-btn.danger:hover { background: #ffebee; }

        .cards-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; }

        /* --- CARD DESIGN (PREMIUM) --- */
        .card-wrapper { flex: 1 1 300px; max-width: 360px; min-width: 280px; height: 500px; perspective: 1000px; cursor: pointer; }
        .card-wrapper.hidden-card { display: none; }
        
        .card-flipper { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1); transform-style: preserve-3d; border-radius: var(--border-radius); box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        .card-wrapper.flipped .card-flipper { transform: rotateY(180deg); }

        .card-front, .card-back { 
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; 
            border-radius: var(--border-radius); background: white; display: flex; flex-direction: column; overflow: hidden; 
        }
        .card-back { transform: rotateY(180deg); background: #fff; border: 1px solid #eee; }

        .card-visual-header { 
            padding: 40px 25px; text-align: center; color: white; flex-shrink: 0; position: relative; 
            /* Subtle texture overlay */
            background-image: linear-gradient(rgba(0,0,0,0.1), rgba(0,0,0,0.3));
        }
        
        .topic-icon { font-size: 54px; margin-bottom: 15px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        .custom-img-icon { height: 60px; width: auto; object-fit: contain; margin-bottom: 15px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        
        .card-title { font-size: 22px; font-weight: 800; margin: 0; line-height: 1.2; text-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .card-time { 
            background: rgba(33,33,33, 0.7); color: var(--cru-gold);
            padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 700; 
            display: inline-block; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px;
        }

        .card-body { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .click-hint { 
            text-align: center; color: #ccc; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; 
            margin-top: auto; padding-bottom: 10px; font-weight: 600;
        }
        
        .card-footer { padding: 25px; display: flex; justify-content: center; border-top: 1px solid #f9f9f9; background: #fff; }

        /* VOTE BUTTON */
        .vote-btn { 
            background: white; border: 2px solid #eee; color: var(--text-light); 
            padding: 12px 30px; border-radius: 50px; font-weight: 700; font-size: 14px;
            cursor: pointer; display: flex; gap: 10px; align-items: center; transition: 0.3s;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .vote-btn:hover { border-color: var(--cru-gold); color: var(--cru-dark); }
        
        .vote-btn.voted { 
            background: var(--cru-gold); border-color: var(--cru-gold); color: var(--cru-dark); 
            box-shadow: 0 5px 15px rgba(249, 182, 37, 0.4);
        }
        .vote-count-badge { background: rgba(0,0,0,0.1); color: inherit; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 800;}

        /* BACK SIDE TEXT */
        .card-back-header {
            padding: 20px 30px; border-bottom: 1px solid #eee;
        }
        .card-back-header h2 { margin: 0; font-size: 18px; color: var(--cru-dark); }

        .card-back h3 { 
            color: var(--cru-gold); font-size: 12px; font-weight: 800; letter-spacing: 1px; 
            text-transform: uppercase; margin-bottom: 10px; margin-top: 0;
        }
        .card-back p { font-size: 15px; color: var(--text-main); margin-bottom: 25px; font-weight: 400; }
        .card-back ul { padding-left: 20px; margin-bottom: 20px; }
        .card-back li { margin-bottom: 8px; font-size: 14px; }

        /* CHECKMARK OVERLAY */
        .complete-btn {
            position: absolute; top: 15px; right: 15px; width: 40px; height: 40px;
            background: var(--white); color: #27ae60; border-radius: 50%; border: none;
            font-size: 20px; cursor: pointer; display: none; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 10;
        }

    </style>
</head>
<body>

<div id="creatorView" class="container">
    <div class="header-logo">
        <h1>Agenda Builder</h1>
    </div>
    
    <div class="dashboard-grid">
        
        <div class="panel">
            <h2><i class="fa-solid fa-pen-to-square" style="color:var(--cru-gold)"></i> Новая карточка</h2>
            
            <div class="form-group">
                <label>Название вопроса</label>
                <input type="text" id="inpTitle" placeholder="Пример: Стратегия 2025">
            </div>

            <div class="form-group">
                <label>Время</label>
                <input type="text" id="inpTime" placeholder="Пример: 30 мин">
            </div>

            <div class="form-group">
                <label>Иконка</label>
                <input type="text" id="inpImgUrl" placeholder="Ссылка на картинку (https://...)" style="display:none; margin-bottom:10px;">
                <div class="icon-grid" id="iconSelector"></div>
                <div class="url-input-toggle" onclick="toggleUrlInput()">Использовать свою картинку (URL)</div>
            </div>

            <div class="form-group">
                <label>Описание (Контекст)</label>
                <textarea id="inpDesc" placeholder="О чем пойдет речь?"></textarea>
            </div>

            <div class="form-group">
                <label>Ожидаемый результат</label>
                <textarea id="inpExpect" placeholder="Какое решение нужно принять?"></textarea>
            </div>

            <button class="btn-primary" onclick="addCardToList()">
                <i class="fa-solid fa-plus"></i> Добавить вопрос
            </button>
        </div>

        <div class="panel">
            <h2><i class="fa-solid fa-list-ul" style="color:var(--cru-gold)"></i> Список вопросов (<span id="countDisplay">0</span>)</h2>
            <div id="previewList" class="preview-list">
                <div style="text-align:center; color:#ccc; padding:40px 0; font-size: 14px;">
                    <i class="fa-regular fa-folder-open" style="font-size:30px; display:block; margin-bottom:10px;"></i>
                    Список пуст
                </div>
            </div>

            <div class="create-section">
                <label>ID Встречи (ссылка)</label>
                <input type="text" id="meetingSlug" class="slug-input" placeholder="team-meeting-name">
                <button class="btn-secondary" onclick="publishMeeting()">Создать встречу</button>
            </div>
        </div>

    </div>
</div>

<div id="votingView" class="container hidden">
    <div class="voting-header">
        <div class="meeting-title">
            <span style="color:var(--cru-gold); margin-right:5px;">///</span> 
            <span id="meetingTitleDisplay">Meeting</span>
        </div>
        <div>
            <button class="header-btn" onclick="shareLink()"><i class="fa-solid fa-link"></i> Ссылка</button>
            <button class="header-btn" id="showAllBtn"><i class="fa-solid fa-eye"></i> Архив</button>
            <button class="header-btn danger" id="resetBtn"><i class="fa-solid fa-rotate-right"></i> Сброс</button>
        </div>
    </div>
    <div class="cards-container" id="cardsContainer"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction, set, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // -----------------------------------------------------------
    // КОНФИГУРАЦИЯ FIREBASE
    // -----------------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBZuH0pKTmfLbyz9lg1g0cC5S4MM16XpMk",
      authDomain: "cru-moldova-ivan.firebaseapp.com",
      databaseURL: "https://cru-moldova-ivan-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cru-moldova-ivan",
      storageBucket: "cru-moldova-ivan.appspot.com",
      messagingSenderId: "913901012780",
      appId: "1:913901012780:web:aefc6983075e50e4000e89",
      measurementId: "G-2JYYSMTDER"
    };
    // -----------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- STATE ---
    let tempAgenda = [];
    let selectedIcon = "fa-comments";
    
    // Палитра Cru: спокойные, профессиональные цвета для шапок карточек
    const palette = [
        "#007398", // Cru Blue
        "#212121", // Cru Dark
        "#3B3B3B", // Dark Gray
        "#546E7A", // Slate
        "#00695C", // Deep Teal
        "#AD1457", // Professional Berry (Accent)
        "#455A64"  // Blue Grey
    ];
    
    const icons = [
        "fa-comments", "fa-bullhorn", "fa-users", "fa-chart-pie", "fa-rocket", 
        "fa-hand-holding-dollar", "fa-earth-europe", "fa-lightbulb", "fa-handshake", 
        "fa-calendar-days", "fa-star", "fa-heart", "fa-bolt", "fa-book"
    ];

    // --- ROUTING ---
    const urlParams = new URLSearchParams(window.location.search);
    const mId = urlParams.get('id');

    if (mId) {
        document.getElementById('creatorView').classList.add('hidden');
        document.getElementById('votingView').classList.remove('hidden');
        document.getElementById('meetingTitleDisplay').innerText = mId;
        initVoting(mId);
    } else {
        initIconGrid();
    }

    // --- CREATOR FUNCTIONS ---
    function initIconGrid() {
        const grid = document.getElementById('iconSelector');
        grid.innerHTML = '';
        icons.forEach(icon => {
            const div = document.createElement('div');
            div.className = `icon-option ${icon === selectedIcon ? 'selected' : ''}`;
            div.innerHTML = `<i class="fa-solid ${icon}"></i>`;
            div.onclick = () => selectIcon(div, icon);
            grid.appendChild(div);
        });
    }

    window.selectIcon = (el, iconClass) => {
        document.querySelectorAll('.icon-option').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        selectedIcon = iconClass;
        document.getElementById('inpImgUrl').value = '';
    }

    window.toggleUrlInput = () => {
        const input = document.getElementById('inpImgUrl');
        input.style.display = input.style.display === 'none' ? 'block' : 'none';
        if(input.style.display === 'block') input.focus();
    }

    window.addCardToList = () => {
        const title = document.getElementById('inpTitle').value;
        const time = document.getElementById('inpTime').value;
        const desc = document.getElementById('inpDesc').value;
        const expect = document.getElementById('inpExpect').value;
        const customUrl = document.getElementById('inpImgUrl').value;

        if(!title) return alert("Введите название вопроса!");

        tempAgenda.push({
            id: Date.now(),
            title,
            time: time || "15 мин",
            desc,
            expect,
            icon: selectedIcon,
            customUrl: customUrl,
            color: palette[tempAgenda.length % palette.length]
        });

        // Reset inputs
        document.getElementById('inpTitle').value = "";
        document.getElementById('inpTime').value = "";
        document.getElementById('inpDesc').value = "";
        document.getElementById('inpExpect').value = "";
        document.getElementById('inpImgUrl').value = "";
        
        renderPreview();
    };

    function renderPreview() {
        const list = document.getElementById('previewList');
        document.getElementById('countDisplay').innerText = tempAgenda.length;
        
        if(tempAgenda.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">Список пуст</div>';
            return;
        }

        list.innerHTML = '';
        tempAgenda.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'preview-item';
            
            let iconDisplay = `<i class="fa-solid ${item.icon}"></i>`;
            if(item.customUrl) iconDisplay = `<img src="${item.customUrl}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;

            div.innerHTML = `
                <div style="width:30px; text-align:center; color:${item.color}">${iconDisplay}</div>
                <div style="flex-grow:1">
                    <div class="preview-title">${item.title}</div>
                    <div class="preview-time">${item.time}</div>
                </div>
                <button class="btn-delete" onclick="removeCard(${index})"><i class="fa-solid fa-times"></i></button>
            `;
            list.appendChild(div);
        });
    }

    window.removeCard = (index) => {
        tempAgenda.splice(index, 1);
        renderPreview();
    }

    window.publishMeeting = async () => {
        const slug = document.getElementById('meetingSlug').value.trim() || 'meeting-' + Math.floor(Math.random()*10000);
        if(tempAgenda.length === 0) return alert("Добавьте вопросы!");

        const finalAgenda = tempAgenda.map((item, idx) => ({ ...item, id: idx + 1 }));
        await set(ref(db, `meetings/${slug}/agenda`), finalAgenda);
        window.location.href = `?id=${slug}`;
    }


    // --- VOTING VIEW ---
    async function initVoting(meetingId) {
        const agendaRef = ref(db, `meetings/${meetingId}/agenda`);
        const snapshot = await get(agendaRef);
        
        if (!snapshot.exists()) {
            document.getElementById('cardsContainer').innerHTML = '<h3 style="color:#666; text-align:center; width:100%">Встреча не найдена</h3>';
            return;
        }

        const agendaData = snapshot.val();
        const container = document.getElementById('cardsContainer');
        const myVotes = JSON.parse(localStorage.getItem(`votes_${meetingId}`)) || {};

        agendaData.forEach(item => {
            let visualHeaderContent = `<i class="topic-icon fa-solid ${item.icon}"></i>`;
            if (item.customUrl) {
                // Если картинка the four или флаг - не инвертируем цвет (убираем filter) если это фото, 
                // но для SVG лого часто нужна инверсия. Здесь оставим чистое изображение.
                visualHeaderContent = `<img src="${item.customUrl}" class="custom-img-icon" alt="icon">`;
            }

            const isVoted = myVotes[item.id] ? 'voted' : '';
            const btnText = myVotes[item.id] ? 'ГОЛОС ПРИНЯТ' : 'ГОЛОСОВАТЬ';
            const iconClass = myVotes[item.id] ? 'fa-solid fa-check' : 'fa-regular fa-thumbs-up';

            const html = `
             <div class="card-wrapper" id="card-${item.id}" onclick="this.classList.toggle('flipped')">
                <div class="card-flipper">
                    <div class="card-front">
                        <div class="card-visual-header" style="background: ${item.color}">
                            <button class="complete-btn" id="complete-${item.id}" title="Завершить">
                                <i class="fa-solid fa-check"></i>
                            </button>
                            ${visualHeaderContent}
                            <h2 class="card-title">${item.title}</h2>
                            <span class="card-time">${item.time}</span>
                        </div>
                        <div class="card-body">
                             <div class="click-hint">
                                <i class="fa-solid fa-rotate"></i> Нажми на карточку, чтобы узнать детали
                             </div>
                        </div>
                        <div class="card-footer">
                            <button class="vote-btn ${isVoted}" id="btn-${item.id}">
                                <i class="${iconClass}" id="icon-${item.id}"></i>
                                <span id="text-${item.id}">${btnText}</span>
                                <span class="vote-count-badge" id="count-${item.id}">0</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-back">
                        <div class="card-back-header">
                            <h2 style="color: ${item.color}">${item.title}</h2>
                        </div>
                        <div class="card-body">
                            <h3>Контекст</h3>
                            <p>${(item.desc || 'Нет описания').replace(/\n/g, '<br>')}</p>
                            
                            <h3>Ожидания</h3>
                            <p>${(item.expect || '...').replace(/\n/g, '<br>')}</p>
                        </div>
                    </div>
                </div>
             </div>
            `;
            container.insertAdjacentHTML('beforeend', html);

            setTimeout(() => {
                document.getElementById(`btn-${item.id}`).addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleVote(item.id, meetingId);
                });
                document.getElementById(`complete-${item.id}`).addEventListener('click', (e) => {
                    e.stopPropagation();
                    if(confirm("Скрыть этот вопрос из обсуждения?")) {
                        set(ref(db, `meetings/${meetingId}/hidden/${item.id}`), true);
                    }
                });
            },0);
        });

        // Realtime Listeners
        onValue(ref(db, `meetings/${meetingId}`), (snap) => {
            const data = snap.val() || {};
            const votes = data.votes || {};
            const hidden = data.hidden || {};
            let max = -1;

            agendaData.forEach(i => {
                const card = document.getElementById(`card-${i.id}`);
                const isHidden = hidden[i.id] === true;
                if(isHidden) card.classList.add('hidden-card');
                else {
                    card.classList.remove('hidden-card');
                    if((votes[i.id] || 0) > max) max = votes[i.id] || 0;
                }
            });

            agendaData.forEach(i => {
                if(hidden[i.id]) return;
                const count = votes[i.id] || 0;
                document.getElementById(`count-${i.id}`).innerText = count;
                
                const completeBtn = document.getElementById(`complete-${i.id}`);
                // Показываем галочку лидеру, если есть голоса
                completeBtn.style.display = (max > 0 && count === max) ? 'flex' : 'none';
            });
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
             if(confirm("Сбросить все голоса для этой встречи?")) { 
                 set(ref(db, `meetings/${meetingId}/votes`), {}); 
                 localStorage.removeItem(`votes_${meetingId}`); 
                 location.reload(); 
             }
        });

        document.getElementById('showAllBtn').addEventListener('click', () => {
            if(confirm("Показать скрытые/завершенные вопросы?")) {
                set(ref(db, `meetings/${meetingId}/hidden`), null);
            }
        });
        
        window.shareLink = () => { navigator.clipboard.writeText(window.location.href); alert("Ссылка скопирована!"); };
    }

    function toggleVote(itemId, mId) {
        const myVotes = JSON.parse(localStorage.getItem(`votes_${mId}`)) || {};
        const itemRef = ref(db, `meetings/${mId}/votes/${itemId}`);
        const btn = document.getElementById(`btn-${itemId}`);
        const icon = document.getElementById(`icon-${itemId}`);
        const text = document.getElementById(`text-${itemId}`);

        if (myVotes[itemId]) {
            runTransaction(itemRef, (c) => (c || 0) > 0 ? c - 1 : 0);
            delete myVotes[itemId];
            btn.classList.remove('voted');
            icon.className = 'fa-regular fa-thumbs-up';
            text.innerText = 'ГОЛОСОВАТЬ';
        } else {
            runTransaction(itemRef, (c) => (c || 0) + 1);
            myVotes[itemId] = true;
            btn.classList.add('voted');
            icon.className = 'fa-solid fa-check';
            text.innerText = 'ГОЛОС ПРИНЯТ';
        }
        localStorage.setItem(`votes_${mId}`, JSON.stringify(myVotes));
    }

</script>
</body>
</html>
